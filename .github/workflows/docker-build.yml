name: Docker Build All Images

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Git LFS
        run: git lfs install

      - name: Cache HuggingFace model
        uses: actions/cache@v4
        with:
          path: ./model-assets/clip-vit-base-patch32
          key: clip-vit-base-patch32-${{ hashFiles('make/data_process/Dockerfile') }}

      - name: Clone CLIP model (pointer files)
        run: |
          GIT_LFS_SKIP_SMUDGE=1 git clone https://huggingface.co/openai/clip-vit-base-patch32 ./model-assets/clip-vit-base-patch32

      - name: Pull LFS files with progress
        run: |
          cd ./model-assets/clip-vit-base-patch32
          git lfs pull

      - name: Clean up unnecessary files
        run: |
          rm -rf ./model-assets/clip-vit-base-patch32/.git
          rm -f ./model-assets/clip-vit-base-patch32/flax_model.msgpack
          rm -f ./model-assets/clip-vit-base-patch32/tf_model.h5

      - name: Build base image
        run: docker build --progress=plain -t nexent/nexent-base -f make/base/Dockerfile .

      - name: Build main application image
        run: docker build --progress=plain -t nexent/nexent -f make/main/Dockerfile .

      - name: Build data process image
        run: docker build --progress=plain -t nexent/nexent-data-process -f make/data_process/Dockerfile .

      - name: Build web frontend image
        run: docker build --progress=plain -t nexent/nexent-web -f make/web/Dockerfile . 